---
title: jvm与java体系结构
date: 2021-03-13
tags: jvm
categories: jvm
---

# 字节码

1. Java字节码，指的是用Java语言编译成的字节码，准确的说任何能在JVM平台上执行的字节码格式都是一样的。所以应该统称为：JVM字节码；
2. 不同的编译器，可以编译出相同的字节码文件，字节码文件也可以在不同的JVM上运行；
3. JVM与Java语言并没有必然的联系，它只与特定的二进制文件格式（.class）所关联，.class文件包含了Java虚拟机指令集（或者称为字节码、Bytecodes）和符号表，还有一些其他辅助信息。

# JVM（程序虚拟机）在系统中的位置

![image-20210313062458529](http://mkstatic.lianbian.net/image-20210313062458529.png)

​													运行在操作系统之上的，它与硬件没有直接的交互

# JDK构成

1. 编译成.class文件（javac 前端编译器）

2. API

3. JVM

   ![image-20210313063102634](http://mkstatic.lianbian.net/image-20210313063102634.png)

   

# JVM整体结构

1. HotSpot VM是目前市面上高性能虚拟机的代表作之一；

2. 采用解释器和即时编译器并存的架构；

   ![JVM架构-简图](http://mkstatic.lianbian.net/%E7%AC%AC02%E7%AB%A0_JVM%E6%9E%B6%E6%9E%84-%E7%AE%80%E5%9B%BE.jpg)

# Java代码执行流程

1. Java编译器编译的过程中，任何一个节点执行失败就会造成编译失败；

2. 各个平台JVM内部的实现细节不尽相同，但是它们共同执行的字节码内容是一样的；

3. JVM的主要任务就是负责将字节码装载到其内部，解释/编译为对应平台上的机器指令（即：汇编语言）执行；

4. Java虚拟机使用类加载器（Class Loader）装载 class 文件；

5. 类加载完成之后，会进行字节码校验，字节码校验通过之后 JVM 解释器会把字节码翻译成机器吗（即：汇编语言）交由操作系统执行；

6. 但不是所有的代码都是解释执行的，JVM对此做了优化，Hotspot虚拟机提供了JIT；

   

![image-20210313063821581](http://mkstatic.lianbian.net/image-20210313063821581.png)



# 栈式架构和寄存器架构

## 基于栈式架构的特点

1. 设计和实现更简单，适用于资源受限的系统；
2. 避开了寄存器的分配难题（使用零地址方式分配）；
3. 指令留中的指令大部分是零地址指令，其执行过程依赖于栈。指令集更小，编译器容易实现；
4. 不需要硬件支持，可移植性更好，更好实现跨平台；

## 基于寄存器架构的特点

1. 典型的应用是x86的二进制指令集：比如传统的PC以及Android的Davlik虚拟机；
2. 指令集架构则完全依赖硬件，可移植性差；
3. 性能优秀和执行更高效；
4. 花费更少的指令去完成一项操作；
5. 在大部分情况下，基于寄存器架构的指令往往都以一地址指令、二地址指令和三地址指令为主，而基于栈式架构的指令集却是以零指令为主；

# JVM的架构模型

由于跨平台性的设计，Java的指令都是根据栈来设计的；

不同平台的CPU架构不同，所以不能设计为基于寄存器的；

**优点是跨平台，指令集小，编译器容易实现； **

缺点是性能下降，实现同样的功能需要更多的指令；

# JVM的生命周期

##  JVM的启动

JVM的启动是通过引导类加载器（bootstarp class loader）创建一个初始类（initial class）来完成的，这个类是由虚拟机具体的实现指定的；

## JVM的执行

1. 一个运行中的JVM有着一个清晰的任务：执行Java程序；
2. 程序开始执行它才运行，程序结束时他就停止；
3. 执行一个所谓的Java程序的时候，真真正正在执行的是一个叫做Java虚拟机的进程；

## JVM的退出

1. 正常执行结束；
2. 程序在执行过程中遇到了异常或者错误而异常终止；
3. 由于操作系统出现错误而导致Java虚拟机进程终止；
4. Runtime类 或者 System类的exit方法、Runtime类 halt 方法；
5. JNI（Java Native Interface）规范描述了用JNI Invocation API来加载或者卸载 Java虚拟机时，Java虚拟机的退出情况；